<app-navbar></app-navbar>

<div class="profile-container">
  <div class="message-popup success-message" *ngIf="updateSuccess">
    <div class="message-content">
      <div class="message-icon success-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <div class="message-text">
        <h3>Success!</h3>
        <p>Your changes have been saved successfully.</p>
      </div>
      <button class="close-message" (click)="dismissMessage()">×</button>
    </div>
  </div>

  <div class="message-popup success-message" *ngIf="deleteSuccess">
    <div class="message-content">
      <div class="message-icon success-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <div class="message-text">
        <h3>Success!</h3>
        <p>Your account had been deleted successfully.</p>
      </div>
      <button class="close-message" (click)="dismissMessage()">×</button>
    </div>
  </div>

  <div class="message-popup error-message" *ngIf="errorMessage">
    <div class="message-content">
      <div class="message-icon error-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
      </div>
      <div class="message-text">
        <h3>Error</h3>
        <p>{{ errorMessage }}</p>
      </div>
      <button class="close-message" (click)="dismissMessage()">×</button>
    </div>
  </div>

  <div class="message-popup success-message" *ngIf="passwordChangeSuccess">
    <div class="message-content">
      <div class="message-icon success-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <div class="message-text">
        <h3>Password Updated</h3>
        <p>Your password has been changed successfully.</p>
      </div>
      <button class="close-message" (click)="dismissMessage()">×</button>
    </div>
  </div>

  <div class="message-popup success-message" *ngIf="projectCreatedSuccess">
    <div class="message-content">
      <div class="message-icon success-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <div class="message-text">
        <h3>Project Created</h3>
        <p>Your new project has been created successfully.</p>
      </div>
      <button class="close-message" (click)="dismissMessage()">×</button>
    </div>
  </div>

  <div class="message-popup success-message" *ngIf="certificateValidationSuccess">
    <div class="message-content">
      <div class="message-icon success-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <div class="message-text">
        <h3>Certificate Validated</h3>
        <p>The certificate has been successfully validated.</p>
      </div>
      <button class="close-message" (click)="dismissMessage()">×</button>
    </div>
  </div>

  <div class="loading-indicator" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading your profile...</p>
  </div>

  <div class="profile-content" *ngIf="!loading">
    <div class="profile-header-section">
      <div class="profile-avatar">
        <img [src]="currentUser.pictureLink || 'assets/images/default-avatar.png'" alt="Profile picture">
      </div>
      <div class="profile-info">
        <h1>{{ currentUser.firstName }} {{ currentUser.lastName }}</h1>
        <div class="profile-type">
          <span *ngIf="isSpecialist" class="badge specialist-badge">Specialist</span>
          <span *ngIf="isClient" class="badge client-badge">Client</span>
          <span *ngIf="isAdmin" class="badge admin-badge">Admin</span>
        </div>
      </div>
    </div>

    <div class="profile-tabs">
      <div class="tab" [class.active]="activeTab === 'personal'" (click)="selectTab('personal')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span>Personal Info</span>
      </div>
      
      <div class="tab" *ngIf="!isAdmin" [class.active]="activeTab === 'projects'" (click)="selectTab('projects')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="3" y1="9" x2="21" y2="9"></line>
          <line x1="9" y1="21" x2="9" y2="9"></line>
        </svg>
        <span>Projects</span>
      </div>
      
      <div class="tab" *ngIf="isSpecialist" [class.active]="activeTab === 'specialist'" (click)="selectTab('specialist')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <span>Specialist Details</span>
      </div>
      
      <div class="tab" *ngIf="isAdmin" [class.active]="activeTab === 'certificates'" (click)="selectTab('certificates')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
        </svg>
        <span>Validate Certificates</span>
      </div>
      
      <div class="tab" [class.active]="activeTab === 'settings'" (click)="selectTab('settings')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        <span>Settings</span>
      </div>
    </div>

    <div class="tab-content">
      <div class="tab-panel" *ngIf="activeTab === 'personal'">
        <div class="panel-header">
          <h2>Personal Information</h2>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" [(ngModel)]="currentUser.username" disabled>
          </div>
          
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" [(ngModel)]="currentUser.email" disabled>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="firstName">First Name</label>
            <input type="text" id="firstName" [(ngModel)]="currentUser.firstName">
          </div>
          
          <div class="form-group">
            <label for="lastName">Last Name</label>
            <input type="text" id="lastName" [(ngModel)]="currentUser.lastName">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" [(ngModel)]="currentUser.phoneNumber">
          </div>
          
          <div class="form-group">
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn-secondary" (click)="resetChanges()">Cancel</button>
          <button class="btn-primary" (click)="saveChanges()">Save Changes</button>
        </div>
      </div>
      
      <div class="tab-panel" *ngIf="activeTab === 'projects' && !isAdmin">
        <div class="panel-header">
          <h2>Your Projects</h2>
          <button class="btn-add" *ngIf="!showCreateForm" (click)="toggleCreateForm()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            New Project
          </button>
        </div>
        
        <div class="create-form" *ngIf="showCreateForm">
          <h3>Create New Project</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="projectAddress">Property Address</label>
              <input type="text" id="projectAddress" [(ngModel)]="newProject.address" placeholder="Enter property address">
            </div>
            
            <div class="form-group">
              <label for="projectStatus">Status</label>
              <select id="projectStatus" [(ngModel)]="newProject.status">
                <option [ngValue]="projectStatus.Pending">Pending</option>
                <option [ngValue]="projectStatus.InProgress">In Progress</option>
                <option [ngValue]="projectStatus.Completed">Completed</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group full-width">
              <label for="projectDescription">Description</label>
              <textarea id="projectDescription" [(ngModel)]="newProject.description" rows="4" placeholder="Describe your project"></textarea>
            </div>
          </div>
          
          <div class="form-actions">
            <button class="btn-secondary" (click)="cancelCreateProject()">Cancel</button>
            <button class="btn-primary" (click)="saveNewProject()">Create Project</button>
          </div>
        </div>
        
        <div class="projects-grid" *ngIf="projects && projects.length > 0">
          <div class="project-card" *ngFor="let project of projects" (click)="viewProjectDetails(project.id)">
            <div class="project-card-header">
              <h3>{{project.address}}</h3>
              <span class="status-tag" [ngClass]="getProjectStatusClass(project.status)">
                {{getProjectStatusText(project.status)}}
              </span>
            </div>
            <p class="project-description">{{project.description | slice:0:100}}{{project.description.length > 100 ? '...' : ''}}</p>
            <div class="project-dates">
              <span>Started: {{project.createdAt | date:'mediumDate'}}</span>
              <span>Updated: {{project.updatedAt | date:'mediumDate'}}</span>
            </div>
            <div class="project-card-footer">
              <button class="btn-view">View Details</button>
            </div>
          </div>
        </div>
        
 
        <div class="empty-state" *ngIf="!projects || projects.length === 0">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="9" y1="21" x2="9" y2="9"></line>
          </svg>
          <p>You haven't created any projects yet.</p>
          <button class="btn-primary" (click)="toggleCreateForm()">Create Your First Project</button>
        </div>
      </div>
      
  
      <div class="tab-panel" *ngIf="activeTab === 'specialist' && isSpecialist">
        <div class="panel-header">
          <h2>
            Specialist Information
            <span class="status-tag" [ngClass]="getStatusClass(getStatus())">
              {{ getStatusText(getStatus()) }}
            </span>
          </h2>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Professional License Number</label>
            <input type="text" [value]="getLicense()" disabled>
          </div>
          
          <div class="form-group">
            <label for="experience">Years of Experience</label>
            <input type="number" id="experience" [(ngModel)]="getExperience" [placeholder]="getExperience()">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group full-width">
            <label>Specialization</label>
            <input type="text" [value]="getSpecialization()" disabled>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group full-width">
            <label for="certificate">Certificate</label>
            <div class="certificate-container">
              <img *ngIf="getCertificatePath() && isImage(getCertificatePath())" 
                   [src]="getCertificatePath()" 
                   alt="Specialist Certificate" 
                   class="certificate-img">
              <iframe *ngIf="getCertificatePath() && isPDF(getCertificatePath())" 
                      [src]="getCertificatePath() | safe" 
                      width="100%" 
                      height="400px">
              </iframe>
              
              <a *ngIf="getCertificatePath() && !isImage(getCertificatePath()) && !isPDF(getCertificatePath())" 
                 [href]="getCertificatePath()" 
                 target="_blank" 
                 class="download-btn">
                Download Certificate
              </a>
              
              <div *ngIf="!getCertificatePath()" class="no-certificate">
                No certificate has been uploaded
              </div>
            </div>
            
            <div class="certificate-upload" *ngIf="getStatus() === verificationStatusEnum.Rejected">
              <label class="upload-btn" for="certificateFile">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Upload New Certificate
              </label>
              <input type="file" id="certificateFile" accept=".pdf,.jpg,.jpeg,.png" style="display: none;"
                     (change)="onFileSelected($event)">
            </div>
          </div>
        </div>
        
        <div class="form-row" *ngIf="getAdminNotes()">
            <div class="form-group full-width">
                <label>Admin Notes</label>
                <input type="text" [value]="getAdminNotes()" disabled>
            </div>
        </div>
        
        <div class="form-actions">
          <button class="btn-secondary" (click)="resetChanges()">Cancel</button>
          <button class="btn-primary" (click)="saveChanges()">Save Changes</button>
        </div>
      </div>
      
      <div class="tab-panel" *ngIf="activeTab === 'certificates' && isAdmin">
        <div class="panel-header">
          <h2>Validate Designer Certificates</h2>
          <div class="filter-container">
            <label for="statusFilter">Filter by:</label>
            <select id="statusFilter" [(ngModel)]="certificateStatus" (change)="applyCertificateFilter()" class="status-select">
              <option value="all">All certificates</option>
              <option value="Pending">Pending</option>
              <option value="Approved">Approved</option>
              <option value="Rejected">Rejected</option>
            </select>
          </div>
        </div>
        
        <div class="loading-spinner" *ngIf="certificatesLoading">
          <div class="spinner"></div>
          <p>Loading certificates...</p>
        </div>
        
        <div class="certificates-grid" *ngIf="!certificatesLoading && filteredDesigners.length > 0">
          <div class="certificate-card" *ngFor="let designer of filteredDesigners" (click)="openValidationModal(designer)">
            <div class="certificate-card-header">
              <h3>{{designer.firstName}} {{designer.lastName}}</h3>
              <span class="status-tag" [ngClass]="getStatusClass(designer.status)">
                {{ getStatusText(designer.status) }}
              </span>
            </div>
            <div class="certificate-card-content">
              <p><strong>Email:</strong> {{designer.email}}</p>
              <p *ngIf="designer.adminNotes"><strong>Notes:</strong> {{designer.adminNotes}}</p>
            </div>
            <div class="certificate-card-footer">
              <button class="btn-view">View Certificate</button>
            </div>
          </div>
        </div>
        
        <div class="empty-state" *ngIf="!certificatesLoading && filteredDesigners.length === 0">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.5 2v6h-6"></path>
            <path d="M2.5 22v-6h6"></path>
            <path d="M22 11.5a10 10 0 0 1-10 10"></path>
            <path d="M2 12.5a10 10 0 0 1 10-10"></path>
          </svg>
          <p>No certificates {{certificateStatus !== 'all' ? 'with this status' : ''}} to validate.</p>
        </div>
        
        <div class="modal" *ngIf="isModalOpen && selectedDesigner">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Validate Designer Certificate</h2>
              <button class="close-btn" (click)="closeModal()">×</button>
            </div>
            
            <div class="modal-body">
              <div class="designer-info">
                <h3>{{selectedDesigner.firstName}} {{selectedDesigner.lastName}}</h3>
                <p><strong>Email:</strong> {{selectedDesigner.email}}</p>
              </div>
              
              <div class="certificate-preview">
                <h4>Uploaded Certificate</h4>
                <div *ngIf="selectedDesigner.certificateFilePath" class="certificate-display">
                  <img *ngIf="isImage(selectedDesigner.certificateFilePath)" 
                       [src]="selectedDesigner.certificateFilePath" 
                       alt="Designer Certificate" 
                       class="certificate-img">
              
                  <iframe *ngIf="isPDF(selectedDesigner.certificateFilePath)" 
                          [src]="selectedDesigner.certificateFilePath | safe" 
                          width="100%" 
                          height="400px">
                  </iframe>
              
                  <a *ngIf="!isImage(selectedDesigner.certificateFilePath) && !isPDF(selectedDesigner.certificateFilePath)" 
                     [href]="selectedDesigner.certificateFilePath" 
                     target="_blank" 
                     class="download-btn">
                    Download Certificate
                  </a>
                </div>
              </div>
              
              <form [formGroup]="validationForm" (ngSubmit)="submitValidation()" class="validation-form">
                <div class="form-row">
                  <div class="form-group">
                    <label for="status">Certificate Status:</label>
                    <select id="status" formControlName="status" class="status-select">
                      <option [value]="verificationStatusEnum.Pending">Pending</option>
                      <option [value]="verificationStatusEnum.Approved">Approved</option>
                      <option [value]="verificationStatusEnum.Rejected">Rejected</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-group full-width">
                    <label for="adminNotes">Notes (optional):</label>
                    <textarea 
                      id="adminNotes" 
                      formControlName="adminNotes" 
                      rows="4" 
                      placeholder="Add notes or reason for rejection"></textarea>
                  </div>
                </div>
                
                <div class="form-actions">
                  <button type="button" class="btn-secondary" (click)="closeModal()">Cancel</button>
                  <button type="submit" class="btn-primary" [disabled]="!validationForm.valid">Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      
      <div class="tab-panel" *ngIf="activeTab === 'settings'">
        <div class="panel-header">
          <h2>Account Settings</h2>
        </div>
        
        <div class="settings-section">
          <h3>Change Password</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="currentPassword">Current Password</label>
              <input type="password" id="currentPassword" [(ngModel)]="currentPassword">
            </div>
            
            <div class="form-group">
              <label for="newPassword">New Password</label>
              <input type="password" id="newPassword" [(ngModel)]="newPassword">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="confirmPassword">Confirm New Password</label>
              <input type="password" id="confirmPassword" [(ngModel)]="confirmPassword">
            </div>
            
            <div class="form-group password-form-actions">
              <button class="btn-primary" (click)="updatePassword()">Update Password</button>
            </div>
          </div>
        </div>
        
        <div class="danger-section">
          <h3>Danger Zone</h3>
          <div class="danger-content">
            <p class="warning-text">Once you delete your account, there is no going back. Please be certain.</p>
            
            <div *ngIf="!showDeleteConfirmation">
              <button class="btn-danger" (click)="showDeleteConfirmation = true">Delete Account</button>
            </div>
            
            <div class="delete-confirmation" *ngIf="showDeleteConfirmation">
              <p>Please enter your password to confirm account deletion:</p>
              <div class="form-row">
                <div class="form-group">
                  <input type="password" id="deleteConfirmPassword" [(ngModel)]="deletePassword" placeholder="Enter your password">
                </div>
              </div>
              <div class="form-actions">
                <button class="btn-secondary" (click)="showDeleteConfirmation = false">Cancel</button>
                <button class="btn-danger" (click)="deleteAccount()">Permanently Delete Account</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>